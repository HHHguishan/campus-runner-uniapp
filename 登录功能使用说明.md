# 手机号+验证码登录功能使用说明

## 📁 项目结构

```
uniapp/
├── api/                      # API接口目录
│   └── auth.js              # 认证相关接口
├── utils/                   # 工具类目录
│   ├── config.js           # 后端API配置
│   ├── request.js          # 网络请求封装
│   └── token.js            # Token管理工具
├── pages/                   # 页面目录
│   └── login/              # 登录页面
│       └── login.vue       # 登录页面代码
└── pages.json              # 页面路由配置（已更新）
```

---

## 🚀 快速开始

### 1. 启动后端服务

确保你的 SpringBoot 后端已经启动：

```bash
# 后端默认地址
http://localhost:9090
```

### 2. 配置后端地址（可选）

如果后端地址不是 `localhost:9090`，修改 `utils/config.js`：

```javascript
const BASE_URL = 'http://你的后端IP:9090'
```

### 3. 运行前端项目

使用 HBuilderX 运行到微信小程序开发者工具：

1. 打开 HBuilderX
2. 点击"运行" → "运行到小程序模拟器"
3. 选择微信开发者工具

---

## 🎯 功能特性

### ✅ 已实现功能

1. **手机号格式校验**
   - 11位数字
   - 1开头，第二位为3-9
   - 实时输入验证

2. **验证码发送**
   - 60秒发送间隔（前端倒计时）
   - 每日最多10条（后端限制）
   - 验证码5分钟过期（后端限制）

3. **登录功能**
   - 手机号+验证码登录
   - 登录即注册（首次登录自动创建账号）
   - JWT Token自动存储
   - 用户信息自动保存

4. **错误处理**
   - 网络错误提示
   - 验证码错误提示
   - 发送频率限制提示
   - Token过期自动跳转登录

5. **用户体验优化**
   - 加载状态提示
   - 按钮禁用状态
   - 登录成功后自动跳转
   - 新老用户智能跳转

---

## 📡 API接口说明

### 1. 发送验证码

```javascript
// API: POST /api/sms/send-code
// 参数: phone (手机号)
// 调用示例:
await sendSmsCode('18812345678')
```

**后端限制规则**：
- ✅ 手机号格式：`^1[3-9]\d{9}$`
- ⏰ 60秒发送间隔
- 📅 每日最多10条
- ⏱️ 验证码5分钟过期

### 2. 手机号登录

```javascript
// API: POST /api/auth/login/phone
// 参数:
// {
//   phone: '18812345678',      // 手机号
//   code: '123456',            // 验证码
//   deviceInfo: 'iPhone 15',   // 设备信息（可选）
//   location: '广东省广州市'    // 地理位置（可选）
// }
// 调用示例:
await loginByPhone({
  phone: '18812345678',
  code: '123456',
  deviceInfo: uni.getSystemInfoSync().model
})
```

**返回数据**：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "userId": 1001,
    "mobile": "18812345678",
    "nickname": "手机用户5678",
    "avatar": null,
    "role": 1,
    "isRider": 0,
    "isNewUser": true
  }
}
```

---

## 🔧 配置说明

### utils/config.js

```javascript
{
  BASE_URL: 'http://localhost:9090',        // 后端地址
  API_BASE_URL: 'http://localhost:9090/api', // API完整路径
  REQUEST_TIMEOUT: 30000,                   // 请求超时30秒
  TOKEN_KEY: 'Authorization',               // Token存储key
  USER_INFO_KEY: 'userInfo'                 // 用户信息存储key
}
```

---

## 📝 核心代码说明

### 1. 网络请求封装（utils/request.js）

**特性**：
- ✅ 自动添加JWT Token到请求头
- ✅ 统一错误处理
- ✅ 401自动跳转登录
- ✅ 请求/响应日志
- ✅ 支持GET/POST/PUT/DELETE

**使用示例**：
```javascript
import { get, post } from '@/utils/request.js'

// GET请求
const data = await get('/user/info', { id: 1 })

// POST请求
const result = await post('/order/create', { type: 1, goodsDesc: '帮我买奶茶' })
```

### 2. Token管理（utils/token.js）

**API**：
```javascript
import { setToken, getToken, removeToken, setUserInfo, getUserInfo } from '@/utils/token.js'

// 存储Token
setToken('eyJhbGciOiJIUzI1NiJ9...')

// 获取Token
const token = getToken()

// 清除Token
removeToken()

// 存储用户信息
setUserInfo({ userId: 1001, nickname: '张三' })

// 获取用户信息
const userInfo = getUserInfo()
```

### 3. 登录页面逻辑（pages/login/login.vue）

**关键方法**：

```javascript
// 1. 发送验证码
const sendCode = async () => {
  await sendSmsCode(phone.value)
  // 开启60秒倒计时
  countdown.value = 60
}

// 2. 登录
const handleLogin = async () => {
  const loginResult = await loginByPhone({
    phone: phone.value,
    code: code.value
  })

  // 保存Token和用户信息
  handleLoginSuccess(loginResult.data)

  // 跳转到首页
  uni.switchTab({ url: '/pages/index/index' })
}
```

---

## 🧪 测试流程

### 开发环境测试（推荐）

1. **启动后端**（确保 Redis 和 MySQL 已启动）

2. **发送验证码**：
   ```
   输入手机号：18812345678
   点击"获取验证码"
   ```

3. **查看后端日志**：
   ```
   临时验证码：123456
   ```
   （因为阿里云未配置，会使用临时方案）

4. **输入验证码登录**：
   ```
   输入验证码：123456
   勾选协议
   点击"立即登录"
   ```

5. **登录成功后**：
   - Token自动存储到本地
   - 用户信息自动保存
   - 自动跳转到首页

---

## ⚠️ 常见问题

### 1. 网络请求失败

**问题**：`网络连接失败`

**解决方案**：
- 检查后端是否启动（访问 http://localhost:9090）
- 检查手机和电脑是否在同一局域网
- 确认 `utils/config.js` 中的 `BASE_URL` 是否正确

### 2. 验证码发送失败

**问题**：`发送太频繁，请XX秒后再试`

**解决方案**：
- 等待倒计时结束
- 这是后端的防刷机制（60秒间隔）

### 3. 验证码错误

**问题**：`验证码错误或已过期`

**解决方案**：
- 查看后端日志获取临时验证码
- 确认验证码是否超过5分钟
- 重新获取验证码

### 4. Token过期

**问题**：`登录已过期，请重新登录`

**解决方案**：
- Token有效期为7天
- 过期后会自动跳转到登录页
- 重新登录即可

---

## 📱 页面展示

### 登录页面

```
┌─────────────────────────┐
│                         │
│    欢迎登录             │
│  校园跑腿系统·手机号    │
│    快捷登录             │
│                         │
├─────────────────────────┤
│  手机号                 │
│  +86 [_____________]     │
│                         │
│  验证码                 │
│  [______] [获取验证码]  │
│                         │
├─────────────────────────┤
│    [立即登录]           │
│                         │
│  ☐ 我已阅读并同意...    │
└─────────────────────────┘
```

---

## 🎨 样式定制

所有样式都在 `pages/login/login.vue` 的 `<style>` 标签中：

```css
/* 主题色 */
--primary-color: #07c160;  /* 微信绿 */

/* 可以修改以下变量来定制样式 */
.get-code-btn.active { color: #07c160; }
.login-active { background: #07c160; }
```

---

## 🚀 后续开发建议

### 1. 添加微信登录

```javascript
// api/auth.js 已提供接口
export function loginByWechat(data) {
  return post('/auth/login/wechat', data)
}

// 在登录页面添加微信登录按钮
<button @tap="wechatLogin">微信一键登录</button>
```

### 2. 添加忘记密码功能

```javascript
// TODO: 实现忘记密码/重置密码功能
```

### 3. 添加注册功能（如果需要）

目前是"登录即注册"模式，如果需要单独注册页面：

```javascript
// 创建 pages/register/register.vue
// 调用接口：POST /api/auth/register
```

---

## 📞 技术支持

如有问题，请检查：
1. 后端日志（控制台输出）
2. 前端控制台日志（`console.log`）
3. 网络请求日志（已在 request.js 中打印）

---

*最后更新时间：2025-01-06*
*版本：v1.0.0*
