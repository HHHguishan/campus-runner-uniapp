{"version":3,"file":"login.js","sources":["pages/login/login.vue","D:/Users/windows/Downloads/HBuilderX.4.85.2025110510/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvbG9naW4vbG9naW4udnVl"],"sourcesContent":["<template>\r\n  <view class=\"container\">\r\n    <view class=\"header\">\r\n      <view class=\"welcome-text\">\r\n        <text class=\"title\">欢迎登录</text>\r\n        <text class=\"subtitle\">校园跑腿系统 · 手机号快捷登录</text>\r\n      </view>\r\n    </view>\r\n\r\n    <view class=\"form-section\">\r\n      <view class=\"input-group\">\r\n        <text class=\"label\">手机号</text>\r\n        <view class=\"input-wrapper\">\r\n          <text class=\"area-code\">+86</text>\r\n          <input\r\n            class=\"input-field\"\r\n            type=\"number\"\r\n            v-model=\"phone\"\r\n            placeholder=\"请输入手机号\"\r\n            maxlength=\"11\"\r\n            @input=\"onPhoneInput\"\r\n          />\r\n        </view>\r\n      </view>\r\n\r\n      <view class=\"input-group\">\r\n        <text class=\"label\">验证码</text>\r\n        <view class=\"input-wrapper\">\r\n          <input\r\n            class=\"input-field\"\r\n            type=\"number\"\r\n            v-model=\"code\"\r\n            placeholder=\"请输入6位验证码\"\r\n            maxlength=\"6\"\r\n          />\r\n          <button\r\n            class=\"get-code-btn\"\r\n            :class=\"{ 'active': canGetCode, 'countdown': countdown > 0 }\"\r\n            :disabled=\"!canGetCode || countdown > 0\"\r\n            @click=\"sendCode\"\r\n          >\r\n            {{ countdown > 0 ? `${countdown}s后重发` : '获取验证码' }}\r\n          </button>\r\n        </view>\r\n      </view>\r\n    </view>\r\n\r\n    <view class=\"action-section\">\r\n      <button\r\n        class=\"login-btn\"\r\n        :class=\"{ 'login-active': canLogin }\"\r\n        :disabled=\"!canLogin || isLoading\"\r\n        @click=\"handleLogin\"\r\n      >\r\n        {{ isLoading ? '登录中...' : '立即登录' }}\r\n      </button>\r\n\r\n      <view class=\"protocol-row\">\r\n        <checkbox-group @change=\"handleAgreeChange\">\r\n          <checkbox\r\n            :checked=\"isAgree\"\r\n            value=\"agree\"\r\n            color=\"#07c160\"\r\n            style=\"transform: scale(0.7);\"\r\n          />\r\n        </checkbox-group>\r\n        <text class=\"protocol-text\">\r\n          我已阅读并同意\r\n          <text class=\"link\" @tap=\"showProtocol('user')\">《用户协议》</text>\r\n          和\r\n          <text class=\"link\" @tap=\"showProtocol('privacy')\">《隐私政策》</text>\r\n        </text>\r\n      </view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport { sendSmsCode, loginByPhone, handleLoginSuccess } from '@/api/auth.js';\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      phone: '',        // 手机号\r\n      code: '',         // 验证码\r\n      countdown: 0,     // 倒计时\r\n      isAgree: false,   // 是否同意协议\r\n      isLoading: false  // 登录加载状态\r\n    };\r\n  },\r\n\r\n  computed: {\r\n    // 判断是否可以获取验证码：手机号必须是11位且倒计时结束\r\n    canGetCode() {\r\n      const phoneReg = /^1[3-9]\\d{9}$/;\r\n      return phoneReg.test(this.phone) && this.countdown === 0;\r\n    },\r\n\r\n    // 判断是否可以登录：手机号有效 + 验证码6位 + 已勾选协议\r\n    canLogin() {\r\n      const phoneReg = /^1[3-9]\\d{9}$/;\r\n      return phoneReg.test(this.phone) &&\r\n             this.code.length === 6 &&\r\n             this.isAgree &&\r\n             !this.isLoading;\r\n    }\r\n  },\r\n\r\n  methods: {\r\n    // 处理协议勾选\r\n    handleAgreeChange(e) {\r\n      this.isAgree = e.detail.value.length > 0;\r\n    },\r\n\r\n    // 手机号输入处理（限制只能输入数字）\r\n    onPhoneInput(e) {\r\n      const value = e.detail.value.replace(/\\D/g, ''); // 移除非数字字符\r\n      this.phone = value;\r\n    },\r\n\r\n    // 发送验证码逻辑\r\n    async sendCode() {\r\n      if (!this.canGetCode) return;\r\n\r\n      try {\r\n        uni.showLoading({ title: '发送中...', mask: true });\r\n\r\n        // 调用后端API发送验证码\r\n        await sendSmsCode(this.phone);\r\n\r\n        uni.hideLoading();\r\n        uni.showToast({\r\n          title: '验证码已发送',\r\n          icon: 'success',\r\n          duration: 2000\r\n        });\r\n\r\n        // 开启倒计时\r\n        this.countdown = 60;\r\n        const timer = setInterval(() => {\r\n          this.countdown--;\r\n          if (this.countdown <= 0) {\r\n            clearInterval(timer);\r\n          }\r\n        }, 1000);\r\n\r\n      } catch (error) {\r\n        uni.hideLoading();\r\n\r\n        // 错误信息已经在request.js中统一处理并显示了\r\n        // 这里可以添加额外的错误处理逻辑\r\n        console.error('发送验证码失败:', error);\r\n\r\n        // 如果是频率限制错误，显示剩余等待时间\r\n        if (error.message && error.message.includes('发送太频繁')) {\r\n          // 提取剩余秒数\r\n          const match = error.message.match(/请(\\d+)秒后再试/);\r\n          if (match) {\r\n            const remainingTime = parseInt(match[1]);\r\n            this.countdown = remainingTime;\r\n            const timer = setInterval(() => {\r\n              this.countdown--;\r\n              if (this.countdown <= 0) {\r\n                clearInterval(timer);\r\n              }\r\n            }, 1000);\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    // 登录逻辑\r\n    async handleLogin() {\r\n      if (!this.canLogin) {\r\n        if (!this.isAgree) {\r\n          uni.showToast({\r\n            title: '请先阅读并同意协议',\r\n            icon: 'none'\r\n          });\r\n        }\r\n        return;\r\n      }\r\n\r\n      try {\r\n        this.isLoading = true;\r\n        uni.showLoading({ title: '登录中...', mask: true });\r\n\r\n        // 调用后端登录API\r\n        const loginResult = await loginByPhone({\r\n          phone: this.phone,\r\n          code: this.code,\r\n          deviceInfo: uni.getSystemInfoSync().model, // 设备信息\r\n          location: '' // 可选：地理位置\r\n        });\r\n\r\n        uni.hideLoading();\r\n\r\n        // 处理登录成功\r\n        handleLoginSuccess(loginResult.data);\r\n\r\n        uni.showToast({\r\n          title: '登录成功',\r\n          icon: 'success',\r\n          duration: 1500\r\n        });\r\n\r\n        // 延迟跳转，让用户看到成功提示\r\n        setTimeout(() => {\r\n          // 判断是否是新用户\r\n          if (loginResult.data.isNewUser) {\r\n            // 新用户跳转到完善信息页\r\n            uni.redirectTo({\r\n              url: '/pages/profile/profile'\r\n            });\r\n          } else {\r\n            // 老用户跳转到首页\r\n            uni.switchTab({\r\n              url: '/pages/index/index'\r\n            });\r\n          }\r\n        }, 1500);\r\n\r\n      } catch (error) {\r\n        this.isLoading = false;\r\n        uni.hideLoading();\r\n\r\n        // 错误信息已经在request.js中统一处理并显示了\r\n        console.error('登录失败:', error);\r\n      }\r\n    },\r\n\r\n    // 查看协议\r\n    showProtocol(type) {\r\n      const title = type === 'user' ? '用户协议' : '隐私政策';\r\n      uni.showToast({\r\n        title: `暂未开放${title}`,\r\n        icon: 'none'\r\n      });\r\n      // TODO: 后续可以跳转到专门的协议页面\r\n      // uni.navigateTo({\r\n      //   url: `/pages/protocol/protocol?type=${type}`\r\n      // });\r\n    }\r\n  }\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n.container {\r\n  padding: 60rpx;\r\n  background-color: #ffffff;\r\n  min-height: 100vh;\r\n  box-sizing: border-box;\r\n}\r\n\r\n/* 顶部 */\r\n.header {\r\n  margin-top: 40rpx;\r\n  margin-bottom: 80rpx;\r\n}\r\n\r\n.title {\r\n  font-size: 56rpx;\r\n  font-weight: bold;\r\n  color: #333;\r\n  display: block;\r\n  margin-bottom: 16rpx;\r\n}\r\n\r\n.subtitle {\r\n  font-size: 28rpx;\r\n  color: #999;\r\n}\r\n\r\n/* 表单 */\r\n.form-section {\r\n  margin-bottom: 80rpx;\r\n}\r\n\r\n.input-group {\r\n  margin-bottom: 50rpx;\r\n  border-bottom: 2rpx solid #f5f5f5;\r\n  padding-bottom: 20rpx;\r\n}\r\n\r\n.label {\r\n  font-size: 28rpx;\r\n  color: #333;\r\n  font-weight: 500;\r\n  margin-bottom: 20rpx;\r\n  display: block;\r\n}\r\n\r\n.input-wrapper {\r\n  display: flex;\r\n  align-items: center;\r\n  height: 80rpx;\r\n}\r\n\r\n.area-code {\r\n  font-size: 32rpx;\r\n  font-weight: bold;\r\n  color: #333;\r\n  margin-right: 24rpx;\r\n}\r\n\r\n.input-field {\r\n  flex: 1;\r\n  font-size: 32rpx;\r\n  height: 100%;\r\n}\r\n\r\n/* 验证码按钮样式 */\r\n.get-code-btn {\r\n  font-size: 26rpx;\r\n  color: #999;\r\n  background: #f8f8f8;\r\n  border-radius: 40rpx;\r\n  padding: 0 32rpx;\r\n  height: 64rpx;\r\n  line-height: 64rpx;\r\n  margin: 0;\r\n  border: none;\r\n  transition: all 0.3s;\r\n}\r\n\r\n.get-code-btn::after {\r\n  border: none;\r\n}\r\n\r\n.get-code-btn.active {\r\n  color: #07c160;\r\n  background: rgba(7, 193, 96, 0.1);\r\n}\r\n\r\n.get-code-btn.countdown {\r\n  opacity: 0.6;\r\n}\r\n\r\n.get-code-btn[disabled] {\r\n  opacity: 0.6;\r\n}\r\n\r\n/* 登录按钮 */\r\n.login-btn {\r\n  width: 100%;\r\n  height: 96rpx;\r\n  line-height: 96rpx;\r\n  border-radius: 48rpx;\r\n  background: #e0e0e0;\r\n  color: #fff;\r\n  font-size: 34rpx;\r\n  font-weight: bold;\r\n  margin-bottom: 40rpx;\r\n  transition: all 0.3s;\r\n}\r\n\r\n.login-btn::after {\r\n  border: none;\r\n}\r\n\r\n.login-active {\r\n  background: #07c160;\r\n  box-shadow: 0 10rpx 20rpx rgba(7, 193, 96, 0.25);\r\n}\r\n\r\n.login-btn[disabled] {\r\n  opacity: 0.8;\r\n}\r\n\r\n/* 协议 */\r\n.protocol-row {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.protocol-text {\r\n  font-size: 24rpx;\r\n  color: #999;\r\n  margin-left: 10rpx;\r\n}\r\n\r\n.link {\r\n  color: #07c160;\r\n}\r\n</style>\r\n","import MiniProgramPage from 'E:/Delivery Service Platform/uniapp/pages/login/login.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","sendSmsCode","loginByPhone","handleLoginSuccess"],"mappings":"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"}