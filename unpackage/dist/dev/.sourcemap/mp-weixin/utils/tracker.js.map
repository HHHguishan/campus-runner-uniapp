{"version":3,"file":"tracker.js","sources":["utils/tracker.js"],"sourcesContent":["import { getBaiduLocation } from './location.js'\r\nimport { reportLocation } from '../api/order.js'\r\nimport { getRiderOrders } from '../api/rider.js'\r\nimport { getToken } from './token.js'\r\n\r\nclass RiderTracker {\r\n    constructor() {\r\n        this.timer = null\r\n        this.activeOrderIds = [] // Ê≠£Âú®ËøõË°åÁöÑËÆ¢Âçï ID ÂàóË°®\r\n        this.isReporting = false\r\n    }\r\n\r\n    /**\r\n     * ÂàùÂßãÂåñÂπ∂ÂêØÂä®ÂÖ®Â±ÄÁõëÂê¨\r\n     */\r\n    init() {\r\n        console.log('üöÄ ÂÖ®Â±Ä‰ΩçÁΩÆÁõëÂê¨Âô®Â∑≤ÂàùÂßãÂåñ')\r\n        this.checkAndStart()\r\n\r\n        // ÊØè 2 ÂàÜÈíüÊ£ÄÊü•‰∏ÄÈÅçÊòØÂê¶ÊúâÊñ∞ËÆ¢ÂçïÔºà‰Ωú‰∏∫ÂÖúÂ∫ïÔºâ\r\n        setInterval(() => {\r\n            this.checkAndStart()\r\n        }, 120000)\r\n    }\r\n\r\n    /**\r\n     * Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂºÄÂßãÊ±áÊä•\r\n     */\r\n    async checkAndStart() {\r\n        const token = getToken()\r\n        if (!token) return\r\n\r\n        try {\r\n            // Êü•ËØ¢ÊòØÂê¶ÊúâÈÖçÈÄÅ‰∏≠ÁöÑËÆ¢Âçï\r\n            const res = await getRiderOrders({\r\n                page: 1,\r\n                size: 20, // Ëé∑ÂèñÊâÄÊúâÈÖçÈÄÅ‰∏≠ÁöÑËÆ¢Âçï\r\n                status: 2 // ÈÖçÈÄÅ‰∏≠\r\n            })\r\n\r\n            const newOrderIds = (res.data && res.data.records)\r\n                ? res.data.records.map(r => r.id)\r\n                : []\r\n\r\n            if (newOrderIds.length > 0) {\r\n                // Âà§Êñ≠ËÆ¢ÂçïÂàóË°®ÊòØÂê¶ÊúâÂèòÂåñ\r\n                const isChanged = JSON.stringify(this.activeOrderIds) !== JSON.stringify(newOrderIds)\r\n                this.activeOrderIds = newOrderIds\r\n\r\n                if (!this.isReporting || isChanged) {\r\n                    this.startReporting()\r\n                }\r\n            } else {\r\n                this.stopReporting()\r\n                this.activeOrderIds = []\r\n            }\r\n        } catch (err) {\r\n            console.error('üîç Ê£ÄÊü•ÈÖçÈÄÅËÆ¢ÂçïÂ§±Ë¥•:', err)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ÂºÄÂßã‰∏äÊä•‰ΩçÁΩÆ\r\n     */\r\n    startReporting() {\r\n        if (this.isReporting) {\r\n            // Â¶ÇÊûúÂ∑≤ÁªèÂú®‰∏äÊä•ÔºåÂÆöÊó∂Âô®‰∏çÁî®ÈáçÂºÄÔºåÂè™ÈúÄÁ°Æ‰øù doReport ‰ΩøÁî®ÊúÄÊñ∞ÁöÑ activeOrderIds\r\n            return\r\n        }\r\n        this.isReporting = true\r\n        console.log('üèá ÂºÄÂêØÂ§öËÆ¢Âçï‰ΩçÁΩÆÂêåÊ≠•:', this.activeOrderIds)\r\n\r\n        const doReport = async () => {\r\n            if (this.activeOrderIds.length === 0 || !this.isReporting) return\r\n\r\n            try {\r\n                const loc = await getBaiduLocation()\r\n\r\n                // ‰∏∫ÊØè‰∏Ä‰∏™Ê≠£Âú®ÈÖçÈÄÅÁöÑËÆ¢Âçï‰∏äÊä•‰ΩçÁΩÆ\r\n                const reports = this.activeOrderIds.map(orderId =>\r\n                    reportLocation({\r\n                        orderId: orderId,\r\n                        latitude: loc.latitude,\r\n                        longitude: loc.longitude\r\n                    })\r\n                )\r\n\r\n                await Promise.all(reports)\r\n                console.log('üì° Â§öËÆ¢Âçï‰ΩçÁΩÆÂêåÊ≠•ÊàêÂäü:', loc.latitude, loc.longitude, `(ÂÖ±${this.activeOrderIds.length}Âçï)`)\r\n            } catch (err) {\r\n                console.error('‚ùå Â§öËÆ¢Âçï‰ΩçÁΩÆ‰∏äÊä•Â§±Ë¥•:', err)\r\n            }\r\n        }\r\n\r\n        // Á´ãÂç≥‰∏äÊä•‰∏ÄÊ¨°\r\n        doReport()\r\n        // ËÆæÁΩÆÂÆöÊó∂Âô® 30s\r\n        this.timer = setInterval(doReport, 30000)\r\n\r\n        // Â¶ÇÊûúÊòØÂæÆ‰ø°Â∞èÁ®ãÂ∫èÁéØÂ¢ÉÔºåÂèØ‰ª•Â∞ùËØïÂºÄÂêØËÉåÊôØÂÆö‰ΩçÔºàÂ¶ÇÊûú manifest.json Â∑≤ÈÖçÁΩÆÔºâ\r\n        // #ifdef MP-WEIXIN\r\n        wx.startLocationUpdateBackground({\r\n            success: (res) => {\r\n                console.log('üü¢ ËÉåÊôØÂÆö‰ΩçÂ∑≤ÂºÄÂêØ')\r\n                wx.onLocationChange((res) => {\r\n                    // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞Êõ¥È´òÈ¢ëÁéáÁöÑÂ¢ûÈáè‰∏äÊä•Ôºå‰ΩÜ‰∏∫‰∫ÜÁúÅÁîµÂíåÂêéÁ´ØÂéãÂäõÔºåÊöÇÊó∂Áª¥ÊåÅ 30s ÂÆöÊó∂\r\n                    // Â¶ÇÊûúÈúÄË¶ÅÂÆûÊó∂‰∏ùÊªëÔºåÂèØ‰ª•Âú®ËøôÈáåÂÅö reportLocation\r\n                })\r\n            },\r\n            fail: (err) => {\r\n                console.warn('üü° ËÉåÊôØÂÆö‰ΩçÂºÄÂêØÂ§±Ë¥•ÔºåÂ∞ÜÁª¥ÊåÅÂ∏∏ËßÑ‰∏äÊä•:', err)\r\n            }\r\n        })\r\n        // #endif\r\n    }\r\n\r\n    /**\r\n     * ÂÅúÊ≠¢‰∏äÊä•\r\n     */\r\n    stopReporting() {\r\n        if (this.timer) {\r\n            clearInterval(this.timer)\r\n            this.timer = null\r\n        }\r\n        this.isReporting = false\r\n        console.log('‚èπÔ∏è ÂÖ®Â±Ä‰ΩçÁΩÆ‰∏äÊä•Â∑≤ÂÅúÊ≠¢')\r\n\r\n        // #ifdef MP-WEIXIN\r\n        wx.stopLocationUpdate()\r\n        // #endif\r\n    }\r\n}\r\n\r\nexport default new RiderTracker()\r\n"],"names":["uni","getToken","getRiderOrders","getBaiduLocation","reportLocation","wx","res"],"mappings":";;;;;;AAKA,MAAM,aAAa;AAAA,EACf,cAAc;AACV,SAAK,QAAQ;AACb,SAAK,iBAAiB,CAAE;AACxB,SAAK,cAAc;AAAA,EACtB;AAAA;AAAA;AAAA;AAAA,EAKD,OAAO;AACHA,kBAAAA,MAAA,MAAA,OAAA,0BAAY,gBAAgB;AAC5B,SAAK,cAAe;AAGpB,gBAAY,MAAM;AACd,WAAK,cAAe;AAAA,IACvB,GAAE,IAAM;AAAA,EACZ;AAAA;AAAA;AAAA;AAAA,EAKD,MAAM,gBAAgB;AAClB,UAAM,QAAQC,YAAAA,SAAU;AACxB,QAAI,CAAC;AAAO;AAEZ,QAAI;AAEA,YAAM,MAAM,MAAMC,yBAAe;AAAA,QAC7B,MAAM;AAAA,QACN,MAAM;AAAA;AAAA,QACN,QAAQ;AAAA;AAAA,MACxB,CAAa;AAED,YAAM,cAAe,IAAI,QAAQ,IAAI,KAAK,UACpC,IAAI,KAAK,QAAQ,IAAI,OAAK,EAAE,EAAE,IAC9B,CAAE;AAER,UAAI,YAAY,SAAS,GAAG;AAExB,cAAM,YAAY,KAAK,UAAU,KAAK,cAAc,MAAM,KAAK,UAAU,WAAW;AACpF,aAAK,iBAAiB;AAEtB,YAAI,CAAC,KAAK,eAAe,WAAW;AAChC,eAAK,eAAgB;AAAA,QACxB;AAAA,MACjB,OAAmB;AACH,aAAK,cAAe;AACpB,aAAK,iBAAiB,CAAE;AAAA,MAC3B;AAAA,IACJ,SAAQ,KAAK;AACVF,oBAAAA,MAAc,MAAA,SAAA,0BAAA,gBAAgB,GAAG;AAAA,IACpC;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKD,iBAAiB;AACb,QAAI,KAAK,aAAa;AAElB;AAAA,IACH;AACD,SAAK,cAAc;AACnBA,+DAAY,iBAAiB,KAAK,cAAc;AAEhD,UAAM,WAAW,YAAY;AACzB,UAAI,KAAK,eAAe,WAAW,KAAK,CAAC,KAAK;AAAa;AAE3D,UAAI;AACA,cAAM,MAAM,MAAMG,gCAAkB;AAGpC,cAAM,UAAU,KAAK,eAAe;AAAA,UAAI,aACpCC,yBAAe;AAAA,YACX;AAAA,YACA,UAAU,IAAI;AAAA,YACd,WAAW,IAAI;AAAA,UACvC,CAAqB;AAAA,QACJ;AAED,cAAM,QAAQ,IAAI,OAAO;AACzBJ,sBAAA,MAAA,MAAA,OAAA,0BAAY,iBAAiB,IAAI,UAAU,IAAI,WAAW,KAAK,KAAK,eAAe,MAAM,IAAI;AAAA,MAChG,SAAQ,KAAK;AACVA,sBAAAA,+CAAc,gBAAgB,GAAG;AAAA,MACpC;AAAA,IACJ;AAGD,aAAU;AAEV,SAAK,QAAQ,YAAY,UAAU,GAAK;AAIxCK,kBAAAA,KAAG,8BAA8B;AAAA,MAC7B,SAAS,CAAC,QAAQ;AACdL,sBAAAA,MAAA,MAAA,OAAA,2BAAY,YAAY;AACxBK,2BAAG,iBAAiB,CAACC,SAAQ;AAAA,QAG7C,CAAiB;AAAA,MACJ;AAAA,MACD,MAAM,CAAC,QAAQ;AACXN,sBAAAA,MAAA,MAAA,QAAA,2BAAa,wBAAwB,GAAG;AAAA,MAC3C;AAAA,IACb,CAAS;AAAA,EAEJ;AAAA;AAAA;AAAA;AAAA,EAKD,gBAAgB;AACZ,QAAI,KAAK,OAAO;AACZ,oBAAc,KAAK,KAAK;AACxB,WAAK,QAAQ;AAAA,IAChB;AACD,SAAK,cAAc;AACnBA,kBAAAA,MAAY,MAAA,OAAA,2BAAA,cAAc;AAG1BK,kBAAAA,KAAG,mBAAoB;AAAA,EAE1B;AACL;AAEA,MAAA,eAAe,IAAI,aAAY;;"}