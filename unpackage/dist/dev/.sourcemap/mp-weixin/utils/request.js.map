{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["/**\r\n * ÁΩëÁªúËØ∑Ê±ÇÂ∞ÅË£Ö\r\n * Âü∫‰∫éuni.requestÂ∞ÅË£ÖÁöÑËØ∑Ê±ÇÂ∑•ÂÖ∑\r\n */\r\n\r\nimport { API_BASE_URL, REQUEST_TIMEOUT, TOKEN_KEY } from './config.js'\r\nimport { getToken, clearAuth } from './token.js'\r\n\r\n/**\r\n * ËØ∑Ê±ÇÊã¶Êà™Âô®\r\n * Âú®ËØ∑Ê±ÇÂèëÈÄÅÂâçÁªü‰∏ÄÂ§ÑÁêÜ\r\n * @param {Object} config - ËØ∑Ê±ÇÈÖçÁΩÆ\r\n * @returns {Object} Â§ÑÁêÜÂêéÁöÑËØ∑Ê±ÇÈÖçÁΩÆ\r\n */\r\nfunction requestInterceptor(config) {\r\n\t// 1. Ê∑ªÂä†TokenÂà∞ËØ∑Ê±ÇÂ§¥ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ\r\n\tconst token = getToken()\r\n\tif (token) {\r\n\t\tconfig.header = {\r\n\t\t\t...config.header,\r\n\t\t\t'Authorization': `Bearer ${token}`\r\n\t\t}\r\n\t}\r\n\r\n\t// 2. Ê∑ªÂä†Âü∫Á°ÄURLÔºàÂ¶ÇÊûúconfig.url‰∏çÊòØÂÆåÊï¥URLÔºâ\r\n\tif (!config.url.startsWith('http')) {\r\n\t\tconfig.url = API_BASE_URL + config.url\r\n\t}\r\n\r\n\t// 3. ËÆæÁΩÆÈªòËÆ§Ë∂ÖÊó∂Êó∂Èó¥\r\n\tif (!config.timeout) {\r\n\t\tconfig.timeout = REQUEST_TIMEOUT\r\n\t}\r\n\r\n\t// 4. ÊâìÂç∞ËØ∑Ê±ÇÊó•ÂøóÔºàÂºÄÂèëË∞ÉËØïÁî®Ôºâ\r\n\tconsole.log('üöÄ ËØ∑Ê±ÇÂèëÈÄÅ:', {\r\n\t\turl: config.url,\r\n\t\tmethod: config.method,\r\n\t\tdata: config.data,\r\n\t\theader: config.header\r\n\t})\r\n\r\n\treturn config\r\n}\r\n\r\n/**\r\n * ÂìçÂ∫îÊã¶Êà™Âô®\r\n * Áªü‰∏ÄÂ§ÑÁêÜÂìçÂ∫îÊï∞ÊçÆ\r\n * @param {Object} response - ÂìçÂ∫îÂØπË±°\r\n * @returns {Promise} Â§ÑÁêÜÂêéÁöÑÊï∞ÊçÆ\r\n */\r\nfunction responseInterceptor(response) {\r\n\tconst { statusCode, data } = response\r\n\r\n\tconsole.log('üì• ÂìçÂ∫îÊé•Êî∂:', {\r\n\t\turl: response.config?.url,\r\n\t\tstatusCode,\r\n\t\tdata\r\n\t})\r\n\r\n\t// 1. HTTPÁä∂ÊÄÅÁ†ÅÊ£ÄÊü•\r\n\tif (statusCode >= 200 && statusCode < 300) {\r\n\t\t// 2. ‰∏öÂä°Áä∂ÊÄÅÁ†ÅÊ£ÄÊü•\r\n\t\tif (data.code === 200) {\r\n\t\t\t// ËØ∑Ê±ÇÊàêÂäüÔºåËøîÂõû‰∏öÂä°Êï∞ÊçÆ\r\n\t\t\treturn Promise.resolve(data)\r\n\t\t} else {\r\n\t\t\t// ‰∏öÂä°ÈîôËØØÔºàÂ¶ÇÔºöÈ™åËØÅÁ†ÅÈîôËØØ„ÄÅÂèÇÊï∞ÈîôËØØÁ≠âÔºâ\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: data.message || 'ËØ∑Ê±ÇÂ§±Ë¥•',\r\n\t\t\t\ticon: 'none',\r\n\t\t\t\tduration: 2000\r\n\t\t\t})\r\n\t\t\treturn Promise.reject(new Error(data.message || 'ËØ∑Ê±ÇÂ§±Ë¥•'))\r\n\t\t}\r\n\t}\r\n\r\n\t// 3. ÁâπÊÆäHTTPÁä∂ÊÄÅÁ†ÅÂ§ÑÁêÜ\r\n\tif (statusCode === 401) {\r\n\t\t// TokenËøáÊúüÊàñÊú™ÊéàÊùÉ\r\n\t\tuni.showToast({\r\n\t\t\ttitle: 'ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï',\r\n\t\t\ticon: 'none'\r\n\t\t})\r\n\t\tclearAuth()\r\n\r\n\t\t// Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ\r\n\t\tsetTimeout(() => {\r\n\t\t\tuni.reLaunch({\r\n\t\t\t\turl: '/pages/login/login'\r\n\t\t\t})\r\n\t\t}, 1500)\r\n\r\n\t\treturn Promise.reject(new Error('Êú™ÊéàÊùÉ'))\r\n\t}\r\n\r\n\tif (statusCode === 403) {\r\n\t\tuni.showToast({\r\n\t\t\ttitle: 'Ê≤°ÊúâÊùÉÈôêËÆøÈóÆ',\r\n\t\t\ticon: 'none'\r\n\t\t})\r\n\t\treturn Promise.reject(new Error('Á¶ÅÊ≠¢ËÆøÈóÆ'))\r\n\t}\r\n\r\n\tif (statusCode === 404) {\r\n\t\tuni.showToast({\r\n\t\t\ttitle: 'ËØ∑Ê±ÇÁöÑËµÑÊ∫ê‰∏çÂ≠òÂú®',\r\n\t\t\ticon: 'none'\r\n\t\t})\r\n\t\treturn Promise.reject(new Error('ËµÑÊ∫ê‰∏çÂ≠òÂú®'))\r\n\t}\r\n\r\n\tif (statusCode === 500) {\r\n\t\tuni.showToast({\r\n\t\t\ttitle: 'ÊúçÂä°Âô®ÈîôËØØ',\r\n\t\t\ticon: 'none'\r\n\t\t})\r\n\t\treturn Promise.reject(new Error('ÊúçÂä°Âô®ÈîôËØØ'))\r\n\t}\r\n\r\n\t// 4. ÂÖ∂‰ªñÈîôËØØ\r\n\tuni.showToast({\r\n\t\ttitle: 'ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•',\r\n\t\ticon: 'none'\r\n\t})\r\n\treturn Promise.reject(new Error('ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•'))\r\n}\r\n\r\n/**\r\n * ÈÄöÁî®ËØ∑Ê±ÇÊñπÊ≥ï\r\n * @param {Object} options - ËØ∑Ê±ÇÈÖçÁΩÆ\r\n * @returns {Promise} ËØ∑Ê±ÇÁªìÊûú\r\n */\r\nfunction request(options) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\t// 1. ËØ∑Ê±ÇÊã¶Êà™Â§ÑÁêÜ\r\n\t\tconst config = requestInterceptor({\r\n\t\t\tmethod: 'GET',\r\n\t\t\theader: {\r\n\t\t\t\t'Content-Type': 'application/json'\r\n\t\t\t},\r\n\t\t\t...options\r\n\t\t})\r\n\r\n\t\t// 2. ÂèëËµ∑ËØ∑Ê±Ç\r\n\t\tuni.request({\r\n\t\t\t...config,\r\n\t\t\tsuccess: (response) => {\r\n\t\t\t\tresponseInterceptor(response)\r\n\t\t\t\t\t.then(resolve)\r\n\t\t\t\t\t.catch(reject)\r\n\t\t\t},\r\n\t\t\tfail: (error) => {\r\n\t\t\t\tconsole.error('‚ùå ËØ∑Ê±ÇÂ§±Ë¥•:', error)\r\n\r\n\t\t\t\t// ÁΩëÁªúÈîôËØØÂ§ÑÁêÜ\r\n\t\t\t\tuni.showToast({\r\n\t\t\t\t\ttitle: 'ÁΩëÁªúËøûÊé•Â§±Ë¥•',\r\n\t\t\t\t\ticon: 'none'\r\n\t\t\t\t})\r\n\t\t\t\treject(error)\r\n\t\t\t}\r\n\t\t})\r\n\t})\r\n}\r\n\r\n/**\r\n * GETËØ∑Ê±Ç\r\n * @param {String} url - ËØ∑Ê±ÇÂú∞ÂùÄ\r\n * @param {Object} params - Êü•ËØ¢ÂèÇÊï∞\r\n * @param {Object} options - ÂÖ∂‰ªñÈÖçÁΩÆ\r\n * @returns {Promise} ËØ∑Ê±ÇÁªìÊûú\r\n */\r\nexport function get(url, params = {}, options = {}) {\r\n\treturn request({\r\n\t\turl,\r\n\t\tmethod: 'GET',\r\n\t\tdata: params,\r\n\t\t...options\r\n\t})\r\n}\r\n\r\n/**\r\n * POSTËØ∑Ê±Ç\r\n * @param {String} url - ËØ∑Ê±ÇÂú∞ÂùÄ\r\n * @param {Object} data - ËØ∑Ê±Ç‰ΩìÊï∞ÊçÆ\r\n * @param {Object} options - ÂÖ∂‰ªñÈÖçÁΩÆ\r\n * @returns {Promise} ËØ∑Ê±ÇÁªìÊûú\r\n */\r\nexport function post(url, data = {}, options = {}) {\r\n\treturn request({\r\n\t\turl,\r\n\t\tmethod: 'POST',\r\n\t\tdata,\r\n\t\t...options\r\n\t})\r\n}\r\n\r\n/**\r\n * PUTËØ∑Ê±Ç\r\n * @param {String} url - ËØ∑Ê±ÇÂú∞ÂùÄ\r\n * @param {Object} data - ËØ∑Ê±Ç‰ΩìÊï∞ÊçÆ\r\n * @param {Object} options - ÂÖ∂‰ªñÈÖçÁΩÆ\r\n * @returns {Promise} ËØ∑Ê±ÇÁªìÊûú\r\n */\r\nexport function put(url, data = {}, options = {}) {\r\n\treturn request({\r\n\t\turl,\r\n\t\tmethod: 'PUT',\r\n\t\tdata,\r\n\t\t...options\r\n\t})\r\n}\r\n\r\n/**\r\n * DELETEËØ∑Ê±Ç\r\n * @param {String} url - ËØ∑Ê±ÇÂú∞ÂùÄ\r\n * @param {Object} params - Êü•ËØ¢ÂèÇÊï∞\r\n * @param {Object} options - ÂÖ∂‰ªñÈÖçÁΩÆ\r\n * @returns {Promise} ËØ∑Ê±ÇÁªìÊûú\r\n */\r\nexport function del(url, params = {}, options = {}) {\r\n\treturn request({\r\n\t\turl,\r\n\t\tmethod: 'DELETE',\r\n\t\tdata: params,\r\n\t\t...options\r\n\t})\r\n}\r\n\r\n// ÂØºÂá∫ÈªòËÆ§ÊñπÊ≥ï\r\nexport default request\r\n"],"names":["getToken","API_BASE_URL","REQUEST_TIMEOUT","uni","clearAuth"],"mappings":"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"}