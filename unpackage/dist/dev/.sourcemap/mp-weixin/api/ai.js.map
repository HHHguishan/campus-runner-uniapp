{"version":3,"file":"ai.js","sources":["api/ai.js"],"sourcesContent":["import request from '@/utils/request'\r\nimport { API_BASE_URL } from '@/utils/config'\r\nimport { getToken } from '@/utils/token'\r\n\r\n/**\r\n * 启动 AI 流式对话 (由于是 SSE，uniapp 建议使用插件或定制封装)\r\n * 这里给出一个基于 uni.request 模拟流式的方案\r\n */\r\nexport const getAiChatStream = (message, sessionId = 'default', onMessage, onComplete, onError) => {\r\n    const token = getToken()\r\n    const baseUrl = API_BASE_URL\r\n\r\n    // uniapp 在小程序端对 SSE 支持有限，建议 H5 使用 EventSource，小程序使用 request 的 chunk\r\n    // 为了跨端，这里演示逻辑：\r\n    const requestTask = uni.request({\r\n        url: `${baseUrl}/ai/chat/stream?message=${encodeURIComponent(message)}&sessionId=${encodeURIComponent(sessionId)}`,\r\n        method: 'GET',\r\n        header: {\r\n            'Authorization': token ? `Bearer ${token}` : ''\r\n        },\r\n        enableChunked: true, // 开启分块接收\r\n        success: (res) => {\r\n            onComplete && onComplete()\r\n        },\r\n        fail: (err) => {\r\n            onError && onError(err)\r\n        }\r\n    })\r\n\r\n    // 监听分块响应\r\n    requestTask.onChunkReceived((res) => {\r\n        // res.data 是 ArrayBuffer\r\n        const unit8Array = new Uint8Array(res.data)\r\n        const text = new TextDecoder('utf-8').decode(unit8Array)\r\n        onMessage && onMessage(text)\r\n    })\r\n\r\n    return requestTask\r\n}\r\n\r\n/**\r\n * 获取聊天历史记录\r\n */\r\nexport const getAiChatHistory = (sessionId = 'default') => {\r\n    return request({\r\n        url: `/ai/chat/history?sessionId=${encodeURIComponent(sessionId)}`,\r\n        method: 'GET'\r\n    })\r\n}\r\n\r\n/**\r\n * 清空聊天历史\r\n */\r\nexport const getAiChatSessions = () => {\r\n    return request({\r\n        url: '/ai/chat/sessions',\r\n        method: 'GET'\r\n    })\r\n}\r\n\r\nexport const clearAiHistory = (sessionId = 'default') => {\r\n    return request({\r\n        url: `/ai/chat/history?sessionId=${encodeURIComponent(sessionId)}`,\r\n        method: 'DELETE'\r\n    })\r\n}\r\n"],"names":["getToken","API_BASE_URL","uni","request"],"mappings":";;;;;AAQY,MAAC,kBAAkB,CAAC,SAAS,YAAY,WAAW,WAAW,YAAY,YAAY;AAC/F,QAAM,QAAQA,YAAAA,SAAU;AACxB,QAAM,UAAUC,aAAY;AAI5B,QAAM,cAAcC,cAAG,MAAC,QAAQ;AAAA,IAC5B,KAAK,GAAG,OAAO,2BAA2B,mBAAmB,OAAO,CAAC,cAAc,mBAAmB,SAAS,CAAC;AAAA,IAChH,QAAQ;AAAA,IACR,QAAQ;AAAA,MACJ,iBAAiB,QAAQ,UAAU,KAAK,KAAK;AAAA,IAChD;AAAA,IACD,eAAe;AAAA;AAAA,IACf,SAAS,CAAC,QAAQ;AACd,oBAAc,WAAY;AAAA,IAC7B;AAAA,IACD,MAAM,CAAC,QAAQ;AACX,iBAAW,QAAQ,GAAG;AAAA,IACzB;AAAA,EACT,CAAK;AAGD,cAAY,gBAAgB,CAAC,QAAQ;AAEjC,UAAM,aAAa,IAAI,WAAW,IAAI,IAAI;AAC1C,UAAM,OAAO,IAAI,YAAY,OAAO,EAAE,OAAO,UAAU;AACvD,iBAAa,UAAU,IAAI;AAAA,EACnC,CAAK;AAED,SAAO;AACX;AAKY,MAAC,mBAAmB,CAAC,YAAY,cAAc;AACvD,SAAOC,sBAAQ;AAAA,IACX,KAAK,8BAA8B,mBAAmB,SAAS,CAAC;AAAA,IAChE,QAAQ;AAAA,EAChB,CAAK;AACL;AAKY,MAAC,oBAAoB,MAAM;AACnC,SAAOA,sBAAQ;AAAA,IACX,KAAK;AAAA,IACL,QAAQ;AAAA,EAChB,CAAK;AACL;AAEY,MAAC,iBAAiB,CAAC,YAAY,cAAc;AACrD,SAAOA,sBAAQ;AAAA,IACX,KAAK,8BAA8B,mBAAmB,SAAS,CAAC;AAAA,IAChE,QAAQ;AAAA,EAChB,CAAK;AACL;;;;;"}